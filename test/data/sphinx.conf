# searchd and indexer must be run from the root directory of this lib.

indexer
{
  mem_limit = 64M
}

searchd
{
  address      = localhost
  port         = 3312
  log          = test/data/sphinx.log
  query_log    = test/data/sphinx.query.log
  read_timeout = 5
  max_children = 30
  pid_file     = test/data/sphinx.pid
  max_matches  = 1000
}

source items
{
  type     = mysql
  sql_host = localhost
  sql_user = root
  sql_pass =
  sql_db   = dm_sphinx_adapter_test

  sql_query_pre = set names utf8
  sql_query_pre = \
    replace into delta (name, updated_on) ( \
      select 'items', updated_on \
      from items \
      order by updated_on desc \
      limit 1\
    )

  sql_query = \
    select id, name, likes, unix_timestamp(updated_on) as updated_on \
    from items \
    where updated_on <= ( \
      select updated_on \
      from delta \
      where name = 'items'\
    )

  sql_query_info = select * from items where id = $id
  sql_attr_timestamp = updated_on
}

source items_delta : items
{
  sql_query_pre = set names utf8
  sql_query = \
    select id, name, likes, unix_timestamp(updated_on) as updated_on \
    from items \
    where updated_on > ( \
      select updated_on \
      from delta \
      where name = 'items'\
    )
}

index items
{
  source = items
  path   = test/data/sphinx/items
}

index items_delta : items
{
  source = items_delta
  path   = test/data/sphinx/items_delta
}
