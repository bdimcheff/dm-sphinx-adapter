# searchd and indexer must be run from the root directory of this lib.

indexer
{
  mem_limit = 64M
}

searchd
{
  address      = localhost
  port         = 3312
  log          = test/files/tmp/sphinx.log
  query_log    = test/files/tmp/sphinx.query.log
  read_timeout = 5
  pid_file     = test/files/tmp/sphinx.pid
  max_matches  = 1000
}

source items
{
  type     = mysql
  sql_host = localhost
  sql_user = root
  sql_pass =
  sql_db   = dm_sphinx_adapter_test

  sql_query_pre = set names utf8
  sql_query_pre = \
    replace into delta (name, updated_on) ( \
      select 'items', t_datetime \
      from items \
      order by t_datetime desc \
      limit 1\
    )
  sql_query_info = select * from items where id = $id

  sql_query_pre = set names utf8
  sql_query = \
    select \
      id, \
      t_string, \
      t_text, \
      t_decimal, \
      t_float, \
      t_integer, \
      unix_timestamp(t_datetime) as t_datetime \
    from items \
    where t_datetime <= ( \
      select updated_on \
      from delta \
      where name = 'items' \
    )

  sql_attr_float     = t_decimal
  sql_attr_float     = t_float
  sql_attr_uint      = t_integer
  sql_attr_timestamp = t_datetime
}

source items_delta : items {
  sql_query_pre = set names utf8
  sql_query_pre =
  sql_query     = \
    select \
      id, \
      t_string, \
      t_text, \
      t_decimal, \
      t_float, \
      t_integer, \
      unix_timestamp(t_datetime) as t_datetime \
    from items \
    where t_datetime > ( \
      select updated_on \
      from delta \
      where name = 'items' \
    )
}

index items_main
{
  source = items
  path   = test/files/tmp/items_main
}

index items_delta : items_main
{
  source = items_delta
  path   = test/files/tmp/items_delta
}

index items
{
  type  = distributed
  local = items_main
  local = items_delta
}
